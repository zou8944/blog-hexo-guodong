---
title: Kotlin协程 - 使用篇
date: 2020-05-25 22:57:26
tags:
 - kotlin
 - 协程
categories:
 - 编程语言
---

使用协程已经有较长的时间了，但一直停留在launch、async启动协程，suspend方法挂起的阶段。这段时间系统梳理Kotlin知识时才发现，对于协程（仅对Kotlin）还有很多概念不甚了解。例如CoroutineScope对协程生命周期的重要性、协程父子结构的作用、结构化并发、一些Kotlin协程中约定俗称的规定等。

# 概述

## 解释协程

解释协程这一概念，是个作死的行为，这里斗胆一试。

我们尝试从几个比较流行的说法来解释协程到底是个什么东西，而不是增加一种让人猜不透的说法

1. 协程是轻量级线程

   可以换个说法，协程就是方法调用封装成类线程的API。方法调用当然比线程切换轻量；而封装成类线程的API后，它形似线程（可手动启动、有各种运行状态、能够协作工作、能够并发执行）。因此从这个角度说，它是轻量级线程没错。

   当然，协程绝不仅仅是方法调用，因为方法调用不能在一个方法执行到一半时挂起，之后又在原点恢复。这一点可以使用EventLoop之类的方式实现。想象一下在库级别将回调风格或Promise/Future风格的异步代码封装成同步风格，封装的结果就非常接近协程了。

   而说道协程和线程之间的区别，往大了说，那就是普通函数与线程的区别；往小了说，就是EventLoop和线程的区别。他们之间的唯一的关系，仅仅在于协程的代码是运行在线程中。一个不恰当的类比，人和地球(地球提供生成环境，人在其中生存)

2. 线程运行在内核态，协程运行在用户态

   主要明白什么叫用户态，我们写的几乎所有代码，都执行在用户态，协程对于操作系统来说，第三方提供的库而已，当然运行在用户态。而线程是操作系统级别的东西，运行在内核态。

3. 协程是一个线程框架

   对某些语言，比如Kotlin，这样说是没有问题的，Kotlin的协程库可以指定协程运行的线程池，我们只需要操作协程，必要的线程切换操作交给库，从这个角度来说，协程就是一个线程框架。

   但理论上我们可以在单线程语言如JavaScript上实现协程，这时我们再叫它线程框架可能就不合适了。

我认为，协程要从两方面看

- 概念上：coroutine(协程)和subroutine(子程序)是一个级别的，从命名上可以看出。子程序是一段具备一定功能的代码，一个函数、一个方法都算是一个子程序。而协程，从命名上看，就是相互协作的子程序，多个子程序之间通过一定的机制相互关联、协作地完成某项任务。一个协程可以执行到某个位置挂起，等待另一个协程执行完成再继续执行。
- 实现上：

### 协程解决了什么问题，如果没有协程，我们要如何解决



## Kotlin的协程



# 启动协程



# 核心组件

## 作用域



## 协程上下文

是什么？

### 调度器



### Job



## 自问自答

- CoroutineScope、CoroutineContext、Job的关系
- 为什么不要使用GlobalScope
- 



# Kotlin协程的额外功能

- 异步流
- 通道
- 监督
- 使用协程+通道实现actor





